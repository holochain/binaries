name: Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build-from-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/common-setup

      - name: Build Lair Keystore for x86_64-unknown-linux-gnu
        run: nix build .#lair_keystore_x86_64-linux

      - name: Build Lair Keystore for aarch64-unknown-linux-gnu
        run: nix build .#lair_keystore_aarch64-linux

      - name: Build Lair Keystore for x86_64-pc-windows-gnu
        run: nix build .#lair_keystore_x86_64-windows

      - name: Build Holochain for x86_64-unknown-linux-gnu
        run: nix build .#holochain_x86_64-linux

      - name: Build Holochain for aarch64-unknown-linux-gnu
        run: nix build .#holochain_aarch64-linux

      - name: Build Holochain for x86_64-pc-windows-gnu
        run: nix build .#holochain_x86_64-windows

  build-from-apple:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/common-setup

      - name: Build Lair Keystore for aarch64-apple-darwin
        run: nix build .#lair_keystore_aarch64-apple

      - name: Build Holochain for aarch64-apple-darwin
        run: nix build .#holochain_aarch64-apple

  build-from-legacy-apple:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/common-setup

      - name: Build Lair Keystore for x86_64-apple-darwin
        run: nix build .#lair_keystore_x86_64-apple

      - name: Build Holochain for x86_64-apple-darwin
        run: nix build .#holochain_x86_64-apple

  bundle-x86-64-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/common-setup

      - name: Bundle Lair Keystore
        run: |
          nix bundle .#holonix_lair_keystore
          ./lair-keystore --version

      - name: Bundle Holochain
        run: |
          nix bundle .#holonix_holochain
          ./holochain --version

      - name: Bundle hc CLI
        run: |
          nix bundle .#holonix_hc
          ./hc --version

      - name: Bundle hc-run-local-services CLI
        run: |
          nix bundle .#holonix_hc_run_local_services
          ./hc-run-local-services --version

      - name: Bundle hcterm CLI
        run: |
          nix bundle .#holonix_hcterm
          ./hcterm --version
