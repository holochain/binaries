name: Check

on:
  workflow_dispatch:
    inputs:
      check-tag:
        description: 'Download artifacts for a specific tag and check they run'
        required: true

concurrency:
  group: ${{ github.ref_name }}-${{ inputs.check-tag }}
  cancel-in-progress: true

jobs:
  check-ubuntu-latest:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4

      # Lair Keystore
      - name: Check Lair Keystore
        id: lair-keystore
        run: |
          gh release download ${{ inputs.check-tag }} --pattern 'lair-keystore-x86_64-linux' --repo holochain/holochain
          set +x
          ./lair-keystore-x86_64-linux --version
          result=$?
          set -x
          echo "result=$result" >> "$GITHUB_OUTPUT"
    outputs:
      lair-keystore: ${{ steps.lair-keystore.outputs.result }}

  check-ubuntu-24-04:
    runs-on: ubuntu-24.04
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Check Lair Keystore
        run: |
          gh release download ${{ inputs.check-tag }} --pattern 'lair-keystore-x86_64-linux' --repo holochain/holochain
          set +x
          ./lair-keystore-x86_64-linux --version
          result=$?
          set -x
          echo "ubuntu-latest:lair-keystore-x86_64-linux=$result" >> "$GITHUB_OUTPUT"
    outputs:
      lair-keystore: ${{ steps.lair-keystore.outputs.result }}

  collect-results:
    runs-on: ubuntu-latest
    needs: [check-ubuntu-latest, check-ubuntu-24-04]
    steps:
      - name: Collect results
        run: |
          echo "ubuntu-latest:lair-keystore-x86_64-linux=${{ needs.check-ubuntu-latest.outputs.lair-keystore }}" >> "$GITHUB_OUTPUT"
          echo "ubuntu-24.04:lair-keystore-x86_64-linux=${{ needs.check-ubuntu-24-04.outputs.lair-keystore }}" >> "$GITHUB_OUTPUT"
    
